# Rutils/suggest_pcs.R
#-------------------------------------------------------------------------------

# scFlowKit: Suggest Number of Principal Components for Downstream Analysis
#-------------------------------------------------------------------------------

# ä¸»æˆåˆ†é€‰æ‹©èƒŒæ™¯è¯´æ˜ï¼š
# - æœ¬å‡½æ•°ç”¨äºåŸºäº PCA é™ç»´ç»“æœæ¨èç”¨äºèšç±»ä¸å¯è§†åŒ–çš„ä¸»æˆåˆ†æ•°é‡ã€‚
# - åœ¨ PCA è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªä¸»æˆåˆ†ï¼ˆPCï¼‰è§£é‡ŠåŸå§‹æ•°æ®çš„ä¸€éƒ¨åˆ†å˜å¼‚ï¼›
# - é€šè¿‡ç»„åˆä¸¤ç§å¸¸ç”¨æŒ‡æ ‡é€‰æ‹©åˆç†æ•°é‡çš„ PCsï¼Œé¿å…ä¿¡æ¯æŸå¤±æˆ–å™ªå£°è¿‡å¤šï¼š
#   - ç´¯è®¡æ–¹å·® > 90%ï¼Œä¸”å½“å‰ PC è´¡çŒ® < 5%
#   - æ–¹å·®å˜åŒ–å·®å€¼ > 0.1% çš„æœ€åä¸€ä¸ª PCï¼ˆå³â€œè‚˜éƒ¨æ‹ç‚¹â€ï¼‰

#-------------------------------------------------------------------------------
# suggest_pcs: æ¨èä¸»æˆåˆ†æ•°é‡
#-------------------------------------------------------------------------------
# å‚æ•°:
#   seu: Seurat å¯¹è±¡ï¼ŒåŒ…å« PCA é™ç»´ç»“æœ
#   reduction: ä½¿ç”¨çš„é™ç»´ç»“æœåç§°ï¼Œé»˜è®¤ä¸º "pca"
#   verbose: æ˜¯å¦è¾“å‡ºå»ºè®®è¿‡ç¨‹ä¿¡æ¯ï¼Œé»˜è®¤ TRUE
#
# è¿”å›å€¼:
#   - å»ºè®®ä½¿ç”¨çš„ PC æ•°é‡ï¼ˆæ•´æ•°å€¼ï¼‰
#-------------------------------------------------------------------------------

suggest_pcs <- function(seu, reduction = "pca", verbose = TRUE) {
  # ---------------- å‚æ•°æ£€æŸ¥ ----------------
  if (!inherits(seu, "Seurat")) {
    stop("å‚æ•° 'seu' å¿…é¡»æ˜¯ Seurat å¯¹è±¡", call. = FALSE)
  }
  if (!reduction %in% names(seu@reductions)) {
    stop(glue::glue("Seurat å¯¹è±¡ä¸­æœªæ‰¾åˆ°é™ç»´ç»“æœ '{reduction}'"), call. = FALSE)
  }

  # ---------------- æå– PCA ä¿¡æ¯ ----------------
  stdev <- seu[[reduction]]@stdev # stdevï¼šæ¯ä¸ª PC çš„æ ‡å‡†å·®ï¼Œè¡¨ç¤ºå˜å¼‚å¤§å°
  total_var <- sum(stdev)
  var_ratio <- (stdev / total_var) * 100 # var_ratioï¼šæ¯ä¸ª PC çš„æ–¹å·®è´¡çŒ®æ¯”ä¾‹ï¼ˆ%ï¼‰
  cum_var <- cumsum(var_ratio) # å‰ k ä¸ª PCs çš„ç´¯è®¡æ–¹å·®è´¡çŒ®ï¼ˆ%ï¼‰

  # ---------------- æŒ‡æ ‡ 1 ----------------
  # - ç´¯è®¡è§£é‡Šåº¦ > 90%ï¼Œä¸”å½“å‰ PC è§£é‡Šåº¦ < 5%
  pc_cutoff_1 <- which(cum_var > 90 & var_ratio < 5)[1] # ç¡®ä¿æ¶µç›–å¤§éƒ¨åˆ†å˜å¼‚ï¼ŒåŒæ—¶é¿å…å™ªå£°

  # ---------------- æŒ‡æ ‡ 2 ----------------
  # - è§£é‡Šåº¦ä¸‹é™ > 0.1% çš„æœ€åä¸€ä¸ªä¸»æˆåˆ†ï¼ˆè‚˜éƒ¨ï¼‰
  var_diff <- head(var_ratio, -1) - tail(var_ratio, -1) # æ‰¾åˆ°æ–¹å·®è´¡çŒ®ä¸‹é™é€Ÿåº¦æ˜¾è‘—å‡ç¼“çš„ PCï¼ˆè‚˜éƒ¨ä½ç½®ï¼‰
  pc_cutoff_2 <- if (any(var_diff > 0.1)) {
    max(which(var_diff > 0.1)) + 1
  } else {
    NA
  }

  # ---------------- æœ€ç»ˆæ¨è ----------------
  pcs_suggested <- min(pc_cutoff_1, pc_cutoff_2, na.rm = TRUE)

  # ---------------- è¾“å‡ºä¿¡æ¯ ----------------
  if (verbose) {
    cli::cli_h2("ğŸ“Š å»ºè®®ä¸»æˆåˆ†æ•°")
    cli::cli_text("ğŸ”¹ æŒ‡æ ‡ 1ï¼šç´¯è®¡æ–¹å·® > 90%ï¼Œä¸”å• PC < 5% â†’ {pc_cutoff_1}")
    cli::cli_text("ğŸ”¹ æŒ‡æ ‡ 2ï¼šè§£é‡Šåº¦ä¸‹é™ > 0.1% çš„æœ€åä¸€ä¸ª PC â†’ {pc_cutoff_2}")
    cli::cli_alert_info("ğŸ¯ æ¨èä½¿ç”¨å‰ {pcs_suggested} ä¸ªä¸»æˆåˆ†ç”¨äºåç»­åˆ†æ")
  }

  return(pcs_suggested)
}

#-------------------------------------------------------------------------------
